<html>
<head>
 <title>linkpad 0.1</title>
  <style>
    /*
      HEX: #99bbad
      HEX: #ebd8b7
      HEX: #c6a9a3
      HEX: #9a8194
    https://colorhunt.co/palette/257993
    */
    
    #noteList {
      width: 90%; 
      column-count: 3;
  	  column-gap: 4px;
    }
    
    #tagList {
      float: left;
      width: 70%;
      background-color: #9a8194;
      margin: 2px;
      padding: 4px;
    }
    #options {
      float: left;
      width: 25%;
      margin: 2px;
      padding: 4px;
      background-color: #9a8194;
    }
    .material-icons {
      font-size: 12px;
    }
    
    .note {
      float: left;
      background-color: #ebd8b7;
      width: 96%;
      margin-bottom: 6px;
      filter: drop-shadow(2px 2px 1px #999);
      border: 1px solid #9a8194;
      min-height: 40px;
    }
    .min {
      overflow: hidden;
      height: 30px;
      opacity: 0.6;
    }
    .high {
      background-color: #F08158;
    }
    .done {
      text-decoration: line-through;
      background-color: #CCC;
    }
    .expand {
      height: auto;
    }
    .note .title {
      padding: 2px;
      width: 100%;
      font-family: Verdana;
      font-size: 10px;
    }
    .note .tags {
      float: left;
      padding: 2px;
      color: #999;
      width: 100%;
      min-height: 18px;
    }
    .note .attributes {
      float: left;
      font-size: 8px;
      padding: 2px;
      color: #999;
      width: 60%;
      min-height: 18px;
    }
    .note .date {
      float: right;
      width: 32%;
      font-size: 10px;
      color: #666;
    }
    
    .tag {
      float: left;
      border-radius: 4px;
      background-color: #c6a9a3;
      color: #000;
      margin: 1px;
      margin-right: 4px;
    }
    
    .tag:before {
      content: "#";
      color: #FFF;
    }
    
    .attr {
      float: left;
      border-radius: 4px;
      background-color: #ebd8b7;
      color: #000;
      margin: 1px;
      margin-right: 4px;
    }

    body {
      background-color: #99bbad; 
      font-family: Verdana;
      font-size: 11px;
    }
  </style>
  
  <script type="text/javascript" src="lib/util.js"></script>
  <script type="text/javascript">
    var glob = {'notes': {}, 'tags': [], 'focusTag': null};
  
    function addNote(text) {
      let nid = incrNextId();
      let jsn = {'id': nid, 'text': text, 'tags': "", 'attr': "", 'loc': {}, 'created': null, 'updated': null, 'styles': ""};
      glob.notes[nid] = jsn;
      noteToDom(jsn);
    }
    
    function noteToDom(jsn) {
      let div = document.createElement('div');
      div.id = jsn.id;
      div.className = 'note' + (jsn.styles? " " + jsn.styles: "");
      div.innerHTML = "<div class=\"title\" label=\"" + jsn.id + "\"  contenteditable=\"true\" onblur=\"saveDomNote(" + jsn.id + ")\">" + formatTextToDom(jsn.text) + "</div><div class=\"tags\" contenteditable=\"true\" onblur=\"saveDomNote(" + jsn.id + ")\">" + tagListDom(jsn.tags) + "</div><div class=\"attributes\" contenteditable=\"true\" onblur=\"saveDomNote(" + jsn.id + ")\">"  + attrListDom(jsn.attr) + "</div><div class=\"date\" title=\"id:" + jsn.id + " updated:" + jsn.updated + "\"> <span onclick=\"archiveNote(" + jsn.id + ")\">&DownTeeArrow;</span> <span onclick=\"trashNote(" + jsn.id + ")\">&otimes;</span> " + jsn.created + "</div>";
      
      let n = document.getElementById("noteList");
      n.insertBefore(div, n.childNodes[0]);
    }
    
    function formatTextToDom(str) {
      //str = str.replace("TODO:", "<i class=\"material-icons md-18\">circle_notifications</i> TODO: ");
      //str = str.replace("DONE:", "<i class=\"material-icons md-18\">done</i> DONE: ");
      //str = str.replace(" * ", "<br/><i class=\"material-icons md-18\" style=\"font-size: 9px\">stop_circle</i><span style=\"display:none\"> * </span>");
      str = str.replaceAll("\n", "<br/>");
      str = str.replaceAll("&nbsp;", " ");
      str = str.replaceAll("/\s+/", " ");
      str = str.replaceAll("*", "&bull;");
      
      str = linkify(str);
      
      return str;
    }
    
    function tagListDom(list) {
      let html = "";
      if(list) {
        let tags = list.split(/[\s,]+/); //|(\r?\n|\r)
        for(let i = 0; i < tags.length; i++) {
          if(tags[i].trim() != "")
              html += "<div class=\"tag\">" + tags[i] + "</div>";
      	}
      }
      return html;
    }
    
    function attrListDom(list) {
      let html = "";
      if(list) {
        let attr = list.split(/[\s,]+/); 
        for(let i = 0; i < attr.length; i++) {
          if(attr[i].trim() != "")
              html += "<div class=\"attr\">" + attr[i] + "</div>";
        }
      }
      return html;
    }
    
    function checkTabPress(e) {
        "use strict";
        // pick passed event or global event object if passed one is empty
        e = e || event;
        var activeElement;
        if (e.keyCode == 9) {
            // Here read the active selected link.
            addNote('new text tab');
        }
    }
    
    function incrNextId() {
      let nid = localStorage.getItem('lastId');
      if(!nid)
        nid = 0;
      
      nid = parseInt(nid) + 1;
      localStorage.setItem('lastId', "" + nid);
      
      return nid;
    }
    
    function saveDomNote(id) {
      let jsn = {'id': id};
   	  let d = document.getElementById(id);
      jsn.text = d.children[0].innerText; //.replace(/circle_*/i, '');;
      jsn.tags = d.children[1].innerText.replace(new Array("&nbsp", "\n", ","), " ");
      jsn.attr = d.children[2].innerText.replace(new Array("&nbsp", "\n", ","), " ");
      jsn.styles = (glob.notes[id] ? glob.notes[id].styles : "");
      jsn.created = (glob.notes[id] && glob.notes[id].created ? glob.notes[id].created : (new Date()).toLocaleDateString('nb-NO'));
      jsn.updated = (new Date()).toLocaleDateString('nb-NO');
      if(glob.focusTag && !jsn.tags.includes(glob.focusTag))
      	jsn.tags += " " + glob.focusTag;
      
      saveNote(jsn);
      highlightNote(id);
    }
    
    function saveNote(jsn) {
      try {
    	localStorage.setItem(jsn.id, JSON.stringify(jsn));
        glob.notes[jsn.id] = jsn;
      }
      catch(e) {
        alert("Failed to save: " + e);
      }
    }
    
    function loadAllNotes() {
      let lid = parseInt(localStorage.getItem('lastId'));
      if(!lid) lid = 0;
      
      for(i = 0; i <= lid; i++) {
        loadNote(i);
      }
      
      filterTag(null);
    }
    
    function loadNote(id) {
      let n = localStorage.getItem(id);
      if(n) {
        n = JSON.parse(n);
        noteToDom(n);
        popTagList(n.tags);
        glob.notes[id] = n;
      }
    }
    
    function popTagList(nt) {
      let d = document.getElementById("tagList");
      let tags = nt.split(" ");
      for(let i = 0; i < tags.length; i++) {
      	let t = tags[i].trim();
        if(t != "" && !glob.tags.includes(t)) {
          d.innerHTML += " <div class=\"tag\" onClick=\"javascript:filterTag('" + t + "')\">" + t + "</div>";
          glob.tags.push(t);
        }
      }
    }
    
    function filterTag(t) {
   	  let nd = document.getElementById("noteList");
      for(let i = 0; i < nd.children.length; i++) {
        let n = nd.children[i];
        let tl = n.children[1].innerText;
        
        if(tl.includes("trash") && t != "trash") {
          n.style.display = "none";
        }
        else if(tl.includes(t) || t == null) {
          n.style.display = "block";
        }
        else {
          n.style.display = "none";
        }
      }
    }
    
    function deleteNote(id) {
      let el = document.getElementById(id);
      if(el)
      	el.remove();
      
      delete glob.notes[id]
      localStorage.removeItem(id);
    }
    
    function minNote(id) {
      if(glob.notes[id].styles.indexOf("min") == -1) {
        glob.notes[id].styles += " min";
        document.getElementById(id).classList.add("min");
        saveDomNote(id);
      }
    }
    
    function maxNode(id) {
      glob.notes[id].styles = glob.notes[id].styles.replace("min", "");
      document.getElementById(id).classList.remove("min");
      saveDomNote(id);
    }
    
    function archiveNote(id) {
      let t = glob.notes[id].tags;
      if(!t.includes("archive")) {
        glob.notes[id].tags.push("archive");
        addDomTag(id, "archive");
      }
    }
    
    function trashNote(id) {
      let t = glob.notes[id].tags;
      if(!t.includes("trash")) {
        glob.notes[id].tags.push("trash");
        addDomTag(id, "trash");
      }
    }
    
    function addDomTag(id, tag) {
      let d = document.getElementById(id);
      d.children[1].innerHtml += "<div class=\"tag\">" + tag + "</div>";
    }
    
    function highlightNote(id) {
      // Show signal
      let d = document.getElementById(id);
      d.classList.add("high");
      setTimeout(function(){ document.getElementById(id).classList.remove("high"); }, 2000);
    }
    
    function emptyTrash() {
      let delList = new Array();
      
      for(let id in glob.notes) {
        n = glob.notes[id];
        if(n.tags.includes("trash"))
          delList.push(id);
      }
      
	  if (confirm("Delete " + delList.length + " notes") == true) {
        for(let i = 0; i < delList.length; i ++) {
          deleteNote(delList[i]);
        }
      }
    }
    
    /*
    Ideas for visualizing, strategizing
    One visual canvas, Pixijs
    The canvas has some basic properties (like axis/labels)
    Coloring of note can be adjusted on "degree" of axis (gradient)
    All notes are elements, they are in the sidebar until i drag it to location
    Notes need additional properties: x & y location, nice to have: relation?
    Note text is capped to make it small and compact
    
    Signs:
    https://dev.w3.org/html5/html-author/charref
    */
  </script>
</head>

<body>
  <div id="tagList"><div class="tag" onClick="filterTag(null);" href="#">ALL</div>&nbsp;</div>
  <div id="options">
    <a href="javascript:void(addNote('new note'))">Add note</a> | 
  	<a href="javascript:void(emptyTrash())">Delete trash</a>
  </div>
  <div id="noteList">&nbsp;
  </div>
  
  
  <script type="text/javascript">
    loadAllNotes();

	window.addEventListener('keyup', checkTabPress);
    window.addEventListener('paste', (event) => {
      let text = (event.clipboardData || window.clipboardData).getData('text');
      addNote(text);
    });
  </script>
</body>
</html>
