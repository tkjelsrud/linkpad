<html>
<head>
 <title>linkpad 0.1</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
  <style>
    /*
      HEX: #99bbad
      HEX: #ebd8b7
      HEX: #c6a9a3
      HEX: #9a8194
    https://colorhunt.co/palette/257993
    */
    
    #noteList {
      width: 90%; 
    }
    
    #tagList {
      width: 90%;
      background-color: #9a8194;
      margin-bottom: 10px;
      min-height: 30px;
      padding: 2px;
    }
    .material-icons {
      font-size: 12px;
    }
    
    .note {
      float: left;
      background-color: #ebd8b7;
      width: 30%;
      margin: 4px;
      margin-bottom: 6px;
      margin-right: 6px;
      filter: drop-shadow(2px 2px 1px #999);
      border: 1px solid #9a8194;
      min-height: 40px;
    }
    .high {
      background-color: red;
    }
    .done {
      text-decoration: line-through;
      background-color: #CCC;
    }
    .expand {
      height: auto;
    }
    .note .title {
      padding: 2px;
      width: 100%;
      font-family: Verdana;
      font-size: 10px;
    }
    .note .tags {
      float: left;
      padding: 2px;
      color: #999;
      width: 80%;
    }
    .note .date {
      float: right;
      width: 20%;
      font-size: 10px;
      color: #666;
    }
    
    .tag {
      float: left;
      border-radius: 4px;
      background-color: #c6a9a3;
      color: #000;
      margin: 1px;
      margin-right: 4px;
    }
    
    .tag:before {
      content: "#";
      color: #FFF;
    }

    body {
      background-color: #99bbad; 
      font: Verdana;
      font-size: 12px;
    }
  </style>
  
  <script type="text/javascript" src="lib/util.js"></script>
  <script type="text/javascript">
    var glob = {'notes': {}, 'tags': [], 'focusTag': null};
  
    function addNote(text) {
      let nid = incrNextId();
      let jsn = {'id': nid, 'text': text, 'tags': "", 'loc': {}, 'created': null, 'updated': null, 'styles': ""};
      glob.notes[nid] = jsn;
      noteToDom(jsn);
    }
    
    function noteToDom(jsn) {
      let div = document.createElement('div');
      div.id = jsn.id;
      div.className = 'note' + (jsn.styles? " " + jsn.styles: "");
      div.innerHTML = "<div class=\"title\" label=\"" + jsn.id + "\"  contenteditable=\"true\" onblur=\"saveDomNote(" + jsn.id + ")\">" + linkify(iconify(jsn.text.replace(new Array("\n", "\r", "&nbsp;"), "<br\>"))) + "</div><div class\"tags\" contenteditable=\"true\" onblur=\"saveDomNote(" + jsn.id + ")\">" + tagListDom(jsn.tags) + "</div><div class=\"date\" title=\"id: " + jsn.id + "\">" + jsn.updated + "</div>";
      document.getElementById("noteList").appendChild(div); 
    }
    
    function iconify(str) {
      //str = str.replace("TODO:", "<i class=\"material-icons md-18\">circle_notifications</i> TODO: ");
      //str = str.replace("DONE:", "<i class=\"material-icons md-18\">done</i> DONE: ");
      //str = str.replace(" * ", "<br/><i class=\"material-icons md-18\" style=\"font-size: 9px\">stop_circle</i><span style=\"display:none\"> * </span>");
      str = str.replace("*", "<br/> *");
      return str;
    }
    
    function tagListDom(list) {
      let tags = list.split(/[\s,]+/);
      let html = "";
      for(let i = 0; i < tags.length; i++) {
        if(tags[i].trim() != "")
      		html += "<div class=\"tag\">" + tags[i] + "</div>";
      }
      return html;
    }
    
    function checkTabPress(e) {
        "use strict";
        // pick passed event or global event object if passed one is empty
        e = e || event;
        var activeElement;
        if (e.keyCode == 9) {
            // Here read the active selected link.
            addNote('new text tab');
        }
    }
    
    function incrNextId() {
      let nid = localStorage.getItem('lastId');
      if(!nid)
        nid = 0;
      
      nid = parseInt(nid) + 1;
      localStorage.setItem('lastId', "" + nid);
      
      return nid;
    }
    
    function saveDomNote(id) {
      let jsn = {'id': id};
   	  let d = document.getElementById(id);
      jsn.text = d.children[0].innerText; //.replace(/circle_*/i, '');;
      jsn.tags = d.children[1].innerText;
      jsn.updated = (new Date()).toLocaleDateString('nb-NO');
      if(glob.focusTag && !jsn.tags.includes(glob.focusTag))
      	jsn.tags += " " + glob.focusTag;
      saveNote(jsn);
      highlightNote(id);
    }
    
    function saveNote(jsn) {
      try {
    	localStorage.setItem(jsn.id, JSON.stringify(jsn));
        glob.notes[jsn.id] = jsn;
      }
      catch(e) {
        alert("Failed to save: " + e);
      }
    }
    
    function loadAllNotes() {
      let lid = parseInt(localStorage.getItem('lastId'));
      if(!lid) lid = 0;
      
      for(i = lid; i > 0; i--) {
        loadNote(i);
      }
      
      filterTag(null);
    }
    
    function loadNote(id) {
      let n = localStorage.getItem(id);
      if(n) {
        n = JSON.parse(n);
        noteToDom(n);
        popTagList(n.tags);
        glob.notes[id] = n;
      }
    }
    
    function popTagList(nt) {
      let d = document.getElementById("tagList");
      let tags = nt.split(" ");
      for(let i = 0; i < tags.length; i++) {
      	let t = tags[i].trim();
        if(t != "" && !glob.tags.includes(t)) {
          d.innerHTML += " <div class=\"tag\" onClick=\"javascript:filterTag('" + t + "')\">" + t + "</div>";
          glob.tags.push(t);
        }
      }
    }
    
    function filterTag(t) {
   	  let nd = document.getElementById("noteList");
      for(let i = 0; i < nd.children.length; i++) {
        let n = nd.children[i];
        let tl = n.children[1].innerText;
        
        if(tl.includes("trash") && t != "trash") {
          n.style.display = "none";
        }
        else if(tl.includes(t) || t == null) {
          n.style.display = "block";
        }
        else {
          n.style.display = "none";
        }
      }
    }
    
    function deleteNote(id) {
      let el = document.getElementById(id);
      if(el)
      	el.remove();
      
      delete glob.notes[id]
      localStorage.removeItem(id);
    }
    
    function highlightNote(id) {
      // Show signal
      let d = document.getElementById(id);
      d.classList.add("high");
      setTimeout(function(){ document.getElementById(id).classList.remove("high"); }, 3000);
    }
    
    function emptyTrash() {
      let delList = new Array();
      
      for(let id in glob.notes) {
        n = glob.notes[id];
        if(n.tags.includes("trash"))
          delList.push(id);
      }
      
	  if (confirm("Delete " + delList.length + " notes") == true) {
        for(let i = 0; i < delList.length; i ++) {
          deleteNote(delList[i]);
        }
      }
    }

  </script>
</head>

<body>
  <div id="tagList"><div class="tag" onClick="filterTag(null);" href="#">ALL</div>&nbsp;</div>
  <div id="noteList">&nbsp;
  </div>
  <a href="javascript:void(addNote('new note'))">Add note</a>
  
  <script type="text/javascript">
    loadAllNotes();

	window.addEventListener('keyup', checkTabPress);
    window.addEventListener('paste', (event) => {
      let text = (event.clipboardData || window.clipboardData).getData('text');
      addNote(text);
    });
  </script>
</body>
</html>
